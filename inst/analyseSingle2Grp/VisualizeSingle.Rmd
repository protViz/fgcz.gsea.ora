---
title: "Visualize single GSEA result"
author: "FGCZ"
date: "03/12/2020"
output: html_document
param:
  GSEAResults
---

```{r setup, include=FALSE, echo=FALSE}

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```


```{r setupData}
library(DT)
library(prora)


gseaResult <- GSEAResults$fgseaRes
geneSet <- GSEAResults$geneSet
rankList <- GSEAResults$rankList
relevantResult <- GSEAResults$relevantResult
gsName <- GSEAResults$gsName
threshold <- GSEAResults$threshold
mainPathways <- GSEAResults$mainPathways
map_summaries <- GSEAResults$map_summaries
score <- GSEAResults$score

```

# Summary

Gene Set Enrichment Analysis (GSEA) examines the distribution of a gene-set within a ranked list of proteins. The null hypothesis is that the proteins in the gene set are randomly distributed over the ranked list. The alternative is that most of the proteins are concentrated in one of the ranked list tails. To estimate the p-value an enrichment score (ES) and a normalized enrichment score (NES) for a gene set are computed and compared with the null distribution of the NES. Since we examine dozens of gene-sets and perform multiple tests, the obtained p-values need to be adjusted for multiple testing resulting in a false discovery rate (FDR).


To rank the proteins we used `r score`. 

- Analysis for gene set category: `r gsName`.
- We filtered the gene sets with : `r paste0("FDR < ", threshold)`, where FDR is the false discovery rate.
- We were able to map `r map_summaries$nrow_all` identifiers to `r map_summaries$nrow_mapped` Entrez identifiers.
- Proteins are ranked using the `r score`.


```{r ranklist , fig.cap = "Sorted list of proteins."}
plot(sort(rankList, decreasing = TRUE), type = "h", ylab = score)

```


```{r pval , fig.cap = " Volcano Plot:  -log10(FDR) (Y axis)  vs normalized enrichment score (NES) (X axis)."}
par(mfrow = c(1,2))


plot( fgseaResult$NES ,
     -log10(fgseaResult$padj),
     ylim = c(0, max(c(-log10(0.05), -log10(fgseaResult$padj)), na.rm = TRUE)),
     ylab = "-log10(FDR)", xlab = "NES", pch = 16, main = "")
abline(h = -log10(threshold), col = c(2,3))
```


`r if(nrow(relevantResult) ==0){ paste0("There are NO relevant results with padj < ", threshold, ".")} `

```{r collapsePathway}
if (nrow(relevantResult) > 0) {
  caption <- paste0("All Pathways with padj < ", threshold, ".")
  DT::datatable(relevantResult, caption = caption) %>% 
    formatSignif('NES',2) %>%
    formatSignif(c('pval','padj'), 2)
}
```


```{r showPathways2}
if (nrow(mainPathways) > 0) {
  caption = paste0("Non redundant pathways with padj < ",  threshold,".")
  DT::datatable(mainPathways, caption = caption) %>%
    formatSignif('NES',2) %>%
    formatSignif(c('pval','padj'),2)
}

```


```{r plotGenesets, fig.width=20, fig.height=40, fig.cap="Protein positions in ranked list for non-redundant Pathways"}
if (nrow(mainPathways) > 0) {
  mainGeneSets <- geneSet[mainPathways$pathway]
  plotGseaTable(mainGeneSets, rankList , mainPathways,
                gseaParam = 0.5)
}
```


Do you have further questions, please contact `protinf@fgcz.uzh.ch`.


